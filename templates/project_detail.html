{% extends "layout.html" %}

{% block content %}
    <div class="container">
        <div class="section">
            <div class="section-header">
                <h2>Project: {{ project.name }}</h2>
                <div class="project-actions">
                    <a href="{{ url_for('schedule', project_id=project.id) }}" class="btn btn-primary">View Schedule</a>
                </div>
            </div>

            <!-- Budget Oversight Section -->
            <div class="section">
                <h3>Budget Oversight</h3>
                <div class="budget-controls">
                    <label for="forecasted_budget">Forecasted Budget:</label>
                    <input type="number" id="forecasted_budget" value="{{ project.forecasted_budget | default(0.0) }}" step="0.01">
                    <button id="save-budget-btn" class="btn btn-secondary">Save Budget</button>
                </div>
            </div>

            <!-- Script Content Section -->
            <div class="section">
                <h3>Script File: {{ project.script_file_name }}</h3>
                <button onclick="loadAndAnalyzeScript({{ project.id }})">Analyze Script</button>
                <div id="script-content-display" style="white-space: pre-wrap; background-color: #1e1e1e; padding: 15px; border-radius: 8px; margin-top: 15px; max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- Analysis Results Section -->
            <div class="section">
                <h3>Analysis Results:</h3>
                <div id="script-analysis-results">
                    {% if project.analysis_json %}
                        {% set analysis_data = project.analysis_json | from_json %}
                        <h4>Genre: {{ analysis_data.genre }}</h4>
                        <h4>Characters</h4>
                        <ul>
                            {% for char in analysis_data.characters %}
                                <li><strong>{{ char.name }}</strong> ({{ char.dialogue_lines }} lines)</li>
                            {% endfor %}
                        </ul>

                        <h4>Locations</h4>
                        <ul>
                            {% for loc in analysis_data.locations %}
                                <li><strong>{{ loc.name }}</strong> ({{ loc.scenes }} scenes)</li>
                            {% endfor %}
                        </ul>

                        <h4>Props</h4>
                        <ul>
                            {% for prop in analysis_data.props %}
                                <li>{{ prop }}</li>
                            {% endfor %}
                        </ul>

                        <h4>Estimated Scenes: {{ analysis_data.estimated_scenes }}</h4>
                    {% else %}
                        <p>No analysis found for this script. Click "Analyze Script" to generate one.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Chart Section -->
            <div class="section" id="chart-section" style="display: {% if project.analysis_json %}block{% else %}none{% endif %};">
                <h2>Visual Breakdown</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Character Dialogue Distribution</h3>
                        <canvas id="character-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Scene Location Distribution</h3>
                        <canvas id="location-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let characterChart = null;
        let locationChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            const projectId = {{ project.id }};
            const scriptContentDisplay = document.getElementById('script-content-display');
            const analysisJson = `{{ project.analysis_json | tojson }}`;

            // Function to load script content
            async function loadScriptContent() {
                try {
                    const response = await fetch(`/api/project/${projectId}/script_content`);
                    if (response.ok) {
                        const data = await response.json();
                        scriptContentDisplay.textContent = data.script_content;
                    } else {
                        scriptContentDisplay.textContent = 'Error loading script content.';
                    }
                } catch (error) {
                    console.error('Error loading script content:', error);
                    scriptContentDisplay.textContent = 'Error loading script content.';
                }
            }

            // Load script content on page load
            loadScriptContent();

            // Initial chart rendering if analysis_json exists
            if (analysisJson && analysisJson !== 'null') {
                const analysisData = JSON.parse(analysisJson);
                document.getElementById('chart-section').style.display = 'block';
                createCharacterChart(analysisData.characters);
                createLocationChart(analysisData.locations);
            }
        });

        async function loadAndAnalyzeScript(projectId) {
            const resultsContainer = document.getElementById('script-analysis-results');
            resultsContainer.innerHTML = '<p>Loading script and analyzing, please wait...</p>';

            try {
                // First, load the script content from the server
                const scriptContentResponse = await fetch(`/api/project/${projectId}/script_content`);
                if (!scriptContentResponse.ok) {
                    throw new Error('Failed to load script content.');
                }
                const scriptContentData = await scriptContentResponse.json();
                const scriptText = scriptContentData.script_content;

                if (!scriptText.trim()) {
                    resultsContainer.innerHTML = '<p class="error">Script text cannot be empty.</p>';
                    return;
                }

                // Then, send the script content for analysis
                const analyzeResponse = await fetch('/api/script/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_id: projectId, script: scriptText})
                });
                const data = await analyzeResponse.json();
                displayAnalysisResults(data, projectId);
            } catch (error) {
                resultsContainer.innerHTML = `<p class="error">Failed to analyze script: ${error.message}</p>`;
                console.error("Error analyzing script:", error);
            }
        }

        function displayAnalysisResults(data, projectId) {
            const resultsContainer = document.getElementById('script-analysis-results');
            const chartSection = document.getElementById('chart-section');
            resultsContainer.innerHTML = ''; // Clear previous results
            chartSection.style.display = 'none';

            if (data.error) {
                resultsContainer.innerHTML = `<p class="error">${data.error}</p>`;
                if (data.raw_response_for_debugging) {
                    resultsContainer.innerHTML += `<h4>Raw AI Response:</h4><pre>${data.raw_response_for_debugging}</pre>`;
                }
                return;
            }

            let html = `<h4>Genre: ${data.genre}</h4>`;
            html += '<h4>Characters</h4><ul>';
            data.characters.forEach(char => {
                html += `<li><strong>${char.name}</strong> (${char.dialogue_lines} lines)</li>`;
            });
            html += '</ul>';

            html += '<h4>Locations</h4><ul>';
            data.locations.forEach(loc => {
                html += `<li><strong>${loc.name}</strong> (${loc.scenes} scenes)</li>`;
            });
            html += '</ul>';

            html += '<h4>Props</h4><ul>';
            data.props.forEach(prop => {
                html += `<li>${prop}</li>`;
            });
            html += '</ul>';

            html += `<h4>Estimated Scenes: ${data.estimated_scenes}</h4>`;

            resultsContainer.innerHTML = html;
            chartSection.style.display = 'block'; // Show the charts

            createCharacterChart(data.characters);
            createLocationChart(data.locations);
        }

        function createCharacterChart(characters) {
            const ctx = document.getElementById('character-chart').getContext('2d');
            if (characterChart) {
                characterChart.destroy();
            }
            characterChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: characters.map(c => c.name),
                    datasets: [{
                        label: '# of Dialogue Lines',
                        data: characters.map(c => c.dialogue_lines),
                        backgroundColor: 'rgba(160, 192, 208, 0.5)', // Subtle accent
                        borderColor: 'rgba(160, 192, 208, 1)', // Subtle accent
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#444' }, // Darker grid lines
                            ticks: { color: '#e0e0e0' } // Light text
                        },
                        x: {
                            grid: { color: '#444' },
                            ticks: { color: '#e0e0e0' } // Light text
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' } // Light text for legend
                        }
                    }
                }
            });
        }

        function createLocationChart(locations) {
            const ctx = document.getElementById('location-chart').getContext('2d');
            if (locationChart) {
                locationChart.destroy();
            }
            locationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: locations.map(l => l.name),
                    datasets: [{
                        label: '# of Scenes',
                        data: locations.map(l => l.scenes),
                        backgroundColor: [
                            'rgba(160, 192, 208, 0.5)', // Subtle accent
                            'rgba(120, 150, 160, 0.5)', // Darker subtle accent
                            'rgba(200, 220, 230, 0.5)', // Lighter subtle accent
                            'rgba(90, 110, 120, 0.5)',
                            'rgba(180, 200, 210, 0.5)',
                            'rgba(70, 90, 100, 0.5)'
                        ],
                        borderColor: [
                            'rgba(160, 192, 208, 1)',
                            'rgba(120, 150, 160, 1)',
                            'rgba(200, 220, 230, 1)',
                            'rgba(90, 110, 120, 1)',
                            'rgba(180, 200, 210, 1)',
                            'rgba(70, 90, 100, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' } // Light text for legend
                        }
                    }
                }
            });
        }

        // Budget Save Logic
        const saveBudgetBtn = document.getElementById('save-budget-btn');
        if (saveBudgetBtn) {
            saveBudgetBtn.addEventListener('click', async function() {
                const forecastedBudgetInput = document.getElementById('forecasted_budget');
                const newBudget = parseFloat(forecastedBudgetInput.value);

                if (isNaN(newBudget) || newBudget < 0) {
                    alert('Please enter a valid positive number for the budget.');
                    return;
                }

                try {
                    const response = await fetch(`/api/project/${projectId}/update_budget`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ forecasted_budget: newBudget })
                    });

                    if (response.ok) {
                        alert('Budget updated successfully!');
                    } else {
                        const errorData = await response.json();
                        alert('Error updating budget: ' + errorData.error);
                    }
                } catch (error) {
                    console.error('Error saving budget:', error);
                    alert('An error occurred while saving the budget.');
                }
            });
        }
    </script>
{% endblock %}
