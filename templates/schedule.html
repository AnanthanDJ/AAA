{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="section">
        <h2>Schedule for {{ project.name }}</h2>

        <div class="schedule-controls">
            <button id="add-schedule-btn">Add New Task</button>
        </div>

        <div id="schedule-form-container" style="display: none;">
            <form id="schedule-form">
                <input type="hidden" id="schedule-item-id">
                <label for="task_description">Task Description:</label>
                <input type="text" id="task_description" name="task_description" required>

                <label for="start_date">Start Date:</label>
                <input type="date" id="start_date" name="start_date" required>

                <label for="end_date">End Date:</label>
                <input type="date" id="end_date" name="end_date" required>

                <label for="assigned_to">Assigned To:</label>
                <input type="text" id="assigned_to" name="assigned_to">

                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="On Hold">On Hold</option>
                </select>

                <button type="submit">Save Task</button>
                <button type="button" id="cancel-edit-btn">Cancel</button>
            </form>
        </div>

        <table id="schedule-table">
            <thead>
                <tr>
                    <th>Task Description</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Assigned To</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in schedule_items %}
                <tr data-id="{{ item.id }}">
                    <td>{{ item.task_description }}</td>
                    <td>{{ item.start_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ item.end_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ item.assigned_to if item.assigned_to else 'N/A' }}</td>
                    <td>{{ item.status }}</td>
                    <td>
                        <button class="edit-schedule-btn" data-id="{{ item.id }}">Edit</button>
                        <button class="delete-schedule-btn" data-id="{{ item.id }}">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectId = {{ project.id }};
        const scheduleFormContainer = document.getElementById('schedule-form-container');
        const scheduleForm = document.getElementById('schedule-form');
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const scheduleTableBody = document.querySelector('#schedule-table tbody');

        let isEditMode = false;

        addScheduleBtn.addEventListener('click', function() {
            isEditMode = false;
            scheduleForm.reset();
            document.getElementById('schedule-item-id').value = '';
            scheduleFormContainer.style.display = 'block';
            addScheduleBtn.style.display = 'none';
        });

        cancelEditBtn.addEventListener('click', function() {
            scheduleFormContainer.style.display = 'none';
            addScheduleBtn.style.display = 'block';
        });

        scheduleForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const scheduleItemId = document.getElementById('schedule-item-id').value;
            const task_description = document.getElementById('task_description').value;
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            const assigned_to = document.getElementById('assigned_to').value;
            const status = document.getElementById('status').value;

            const data = {
                task_description,
                start_date,
                end_date,
                assigned_to,
                status
            };

            let url = `/api/schedule/${projectId}`;
            let method = 'POST';

            if (isEditMode) {
                url = `/api/schedule/item/${scheduleItemId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorData = await response.json();
                alert('Error: ' + errorData.error);
            }
        });

        scheduleTableBody.addEventListener('click', async function(event) {
            if (event.target.classList.contains('edit-schedule-btn')) {
                isEditMode = true;
                const itemId = event.target.dataset.id;
                document.getElementById('schedule-item-id').value = itemId;

                const row = event.target.closest('tr');
                document.getElementById('task_description').value = row.children[0].textContent;
                document.getElementById('start_date').value = row.children[1].textContent;
                document.getElementById('end_date').value = row.children[2].textContent;
                document.getElementById('assigned_to').value = row.children[3].textContent === 'N/A' ? '' : row.children[3].textContent;
                document.getElementById('status').value = row.children[4].textContent;

                scheduleFormContainer.style.display = 'block';
                addScheduleBtn.style.display = 'none';
            } else if (event.target.classList.contains('delete-schedule-btn')) {
                if (confirm('Are you sure you want to delete this schedule item?')) {
                    const itemId = event.target.dataset.id;
                    const response = await fetch(`/api/schedule/item/${itemId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error: ' + errorData.error);
                    }
                }
            }
        });
    });
</script>
{% endblock %}