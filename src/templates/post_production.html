{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="section">
        <h2>Post-Production Tracking for {{ project.name }} <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary" style="margin-left: 15px;">View Project Details</a></h2>

        <div class="section">
            <h3>Progress</h3>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ progress }}%;">{{ "%.2f"|format(progress) }}%</div>
            </div>
        </div>

        <div class="section">
            <table id="scenes-table" class="data-table">
                <thead>
                    <tr>
                        <th>Scene Number</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scene in scenes %}
                        <tr data-id="{{ scene.id }}">
                            <td>{{ scene.scene_number }}</td>
                            <td>{{ scene.description }}</td>
                            <td>
                                <select class="status-select" data-id="{{ scene.id }}">
                                    <option value="To Do" {% if scene.status == 'To Do' %}selected{% endif %}>To Do</option>
                                    <option value="In Progress" {% if scene.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                    <option value="Done" {% if scene.status == 'Done' %}selected{% endif %}>Done</option>
                                </select>
                            </td>
                            <td>
                                <button class="delete-scene-btn btn-danger" data-id="{{ scene.id }}">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectId = {{ project.id }};

        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', async function(event) {
                const sceneId = event.target.dataset.id;
                const status = event.target.value;

                const data = { status };

                const response = await fetch(`/api/scene/${sceneId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    alert('Error: ' + errorData.error);
                }
            });
        });

        document.querySelectorAll('.delete-scene-btn').forEach(button => {
            button.addEventListener('click', async function(event) {
                if (confirm('Are you sure you want to delete this scene?')) {
                    const sceneId = event.target.dataset.id;
                    const response = await fetch(`/api/scene/${sceneId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error: ' + errorData.error);
                    }
                }
            });
        });
    });
</script>
{% endblock %}
