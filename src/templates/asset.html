{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="section">
        <h2>Asset Tracking for {{ project.name }} <a href="{{ url_for('project_detail', project_id=project.id) }}" class="btn btn-secondary" style="margin-left: 15px;">View Project Details</a></h2>

        <div id="asset-form-container" class="section">
            <form id="asset-form">
                <input type="hidden" id="asset-id">
                <label for="asset_name">Asset Name:</label>
                <input type="text" id="asset_name" name="asset_name" required>

                <label for="status">Status:</label>
                <select id="status" name="status">
                    <option value="Bought">Bought</option>
                    <option value="Rented">Rented</option>
                </select>

                <label for="cost">Cost:</label>
                <input type="number" id="cost" name="cost" step="0.01" required>

                <button type="submit" class="btn-primary">Add Asset</button>
            </form>
        </div>

        <div class="section">
            <h3>Bought Assets</h3>
            <table id="bought-assets-table" class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in assets %}
                        {% if asset.status == 'Bought' %}
                            <tr data-id="{{ asset.id }}">
                                <td>{{ asset.name }}</td>
                                <td>{{ asset.cost }}</td>
                                <td>
                                    <button class="delete-asset-btn btn-danger" data-id="{{ asset.id }}">Delete</button>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="section">
            <h3>Rented Assets</h3>
            <table id="rented-assets-table" class="data-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Cost</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in assets %}
                        {% if asset.status == 'Rented' %}
                            <tr data-id="{{ asset.id }}">
                                <td>{{ asset.name }}</td>
                                <td>{{ asset.cost }}</td>
                                <td>
                                    <button class="delete-asset-btn btn-danger" data-id="{{ asset.id }}">Delete</button>
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const projectId = {{ project.id }};
        const assetForm = document.getElementById('asset-form');

        assetForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const name = document.getElementById('asset_name').value;
            const status = document.getElementById('status').value;
            const cost = document.getElementById('cost').value;

            const data = {
                name,
                status,
                cost
            };

            const response = await fetch(`/api/project/${projectId}/assets`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                const errorData = await response.json();
                alert('Error: ' + errorData.error);
            }
        });

        document.querySelectorAll('.delete-asset-btn').forEach(button => {
            button.addEventListener('click', async function(event) {
                if (confirm('Are you sure you want to delete this asset?')) {
                    const assetId = event.target.dataset.id;
                    const response = await fetch(`/api/asset/${assetId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        location.reload();
                    } else {
                        const errorData = await response.json();
                        alert('Error: ' + errorData.error);
                    }
                }
            });
        });
    });
</script>
{% endblock %}
